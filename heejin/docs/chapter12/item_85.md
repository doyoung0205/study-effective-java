# 직렬화

[아이템 85. 자바 직렬화의 대안을 찾으라](#자바-직렬화의-대안을-찾으라)  

[- 직렬화 위험을 회피하는 방법](#직렬화-위험을-회피하는-방법)    
[- 정리](#정리)    

<br>

## 자바 직렬화의 대안을 찾으라
- 직렬화는 프로그래머가 어렵지 않게 분산 객체를 만들 수 있다는 점에서 사용되었다.
- 하지만,  보이지 않는 생성자, API와 구현 사이의 모호해진 경계, 잠재적인 정확성 문제, 성능, 보안, 유지보수성 등 그 대가가 컸다.
  - 직렬화의 보안 문제는 실제로 우려한 만큼 심각한 것으로 밝혀졌다.
  - 직렬화의 근본적인 문제는 공격 범위가 너무 넓고 지속적으로 더 넓어져 방어하기 어렵다는 점이다.
  - 자바의 표준 라이브러리나 아파치 커먼즈 컬렉션 같은 서드파티 라이브러리는 물론, 애플리케이션 자신의 클래스도 공격 범위에 포함된다.

> 자바의 역직렬화는 명백하고 현존하는 위험이다. 신뢰할 수 없는 스트림을 역직렬화하면 원격 코드 실행(RCE), 서비스 거부(DoS)등의 공격으로 이어질 수 있다.

- 역질렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드를 가젯(gadget)이라 부른다.
- 역직렬화에 시간이 오래 걸리는 짧은 스트림을 역직렬화하는 것만으로도 서비스 거부 공격에 쉽게 노출될 수 있다. 
  - 이런 스트림을 역직렬화 폭탄이라고 한다.
  - [역직렬화 폭탄 예제 코드](../../src/main/java/study/heejin/chapter12/item85/DeserializationBomb.java)

  
### 직렬화 위험을 회피하는 방법
- 직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다.
  - 애초에 신뢰할 수 없는 바이트 스트림을 역직렬화하는 일 자체가 스스로 공격에 노출하는 행위이다.
- 직렬화 대신 JSON이나 프로토콜 버퍼와 같은 구조화된 데이터 객체를 사용한다.
- 레거시 시스템 때문에 자바 직렬화를 완전히 배제할 수 없을 때의 차선책은 신뢰할 수 없는 데이터는 절대 역직렬화하지 않는 것이다.
  - 특히, 신뢰할 수 없는 발신원으로부터의 RMI는 절대 수용해서는 안된다.
- 직렬화를 피할 수 없고 역직렬화한 데이터가 안전한지 확신할 수 없다면 객체 역직렬화 필터링(`java.io.ObjectInputFilter`)을 사용하자.
  - 객체 역직렬화 필터링은 데이터 스트림이 역직렬화되기 전에 필터를 설치하는 기능이다.
  - 블랙리스트 방식은 잠재적으로 위험한 클래스들을 거부하는 방식이고, 화이트리스트 방식은 안전하다고 알려진 클래스들만 수용하는 방식이다.
  - 블랙리스트 방식보다는 화이트리스트 방식을 추천한다.
  - 필터링 기능은 메모리를 과하게 사용하거나 객체 그래프가 너무 깊어지는 사태로부터 보호해준다.
  - 하지만 직렬화 폭탄은 걸러내지 못한다.


### 정리
- 직렬화는 위험하니 피해야 한다.
- 신뢰할 수 없는 데이터를 역직렬화하지 말자.



<br>
